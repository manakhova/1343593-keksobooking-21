(()=>{"use strict";(()=>{function e(e,t,n,o){const r=new XMLHttpRequest;return r.responseType="json",r.addEventListener("load",(function(){return 200===r.status?n(r.response):o(`Код ошибки: ${r.status} ${r.statusText}`)})),r.addEventListener("error",(function(){return o("Произошла ошибка соединения с сервером "+t)})),r.addEventListener("timeout",(function(){return o(`Запрос на сервер ${t} не успел выполниться за ${r.timeout} мс`)})),r.timeout=1e4,r.open(e,t),r}window.ajax={loadData:function(t,n,o){e("GET",t,n,o).send()},uploadData:function(t,n,o,r){e("POST",t,o,r).send(n)}}})(),(()=>{function e(e,t){return Math.floor(Math.random()*(t+1-e)+e)}window.utils={getRandomInteger:e,getRandomProperty:function(t){const n=Object.keys(t);return t[n[e(0,n.length)]]},shuffleArray:function(e){const t=e.slice();for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t},debounce:function(e,t){let n;return function(){n&&clearTimeout(n),n=setTimeout(e,t)}}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");function t(t){const n=e.cloneNode(!0);n.dataset.offerId=t.id;const o=n.querySelector("img");return o.src=t.author.avatar,o.alt=t.offer.title,n.style.left=t.location.x+"px",n.style.top=t.location.y+"px",n}window.pin={generatePins:function(e){const n=document.createDocumentFragment(),o=e.length>5?5:e.length;for(let r=0;r<o;r++)n.appendChild(t(e[r]));return n}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card");e.querySelector(".popup__features").innerHTML="",e.querySelector(".popup__photos").innerHTML="";const t={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"};window.card={createCardElement:function(n){const o=e.cloneNode(!0);return o.querySelector(".popup__avatar").src=n.author.avatar,o.querySelector(".popup__title").textContent=n.offer.title,o.querySelector(".popup__text--address").textContent=n.offer.adress,o.querySelector(".popup__text--price").textContent=n.offer.price,o.querySelector(".popup__type").textContent=t[n.offer.type],o.querySelector(".popup__text--capacity").textContent=`${n.offer.rooms} комнат(-a/-ы) для ${n.offer.guests} гостей`,o.querySelector(".popup__text--time").textContent=`Заезд после ${n.offer.checkin}, выезд до ${n.offer.checkout}`,o.querySelector(".popup__features").appendChild(function(e){const t=document.createDocumentFragment();for(let n=0;n<e.length;n++){const o=document.createElement("li");o.classList.add("popup__feature","popup__feature--"+e[n]),t.appendChild(o)}return t}(n.offer.features)),o.querySelector(".popup__description").textContent=n.offer.description,o.querySelector(".popup__photos").appendChild(function(e){const t=document.createDocumentFragment();for(let n=0;n<e.length;n++){const o=document.createElement("img");o.classList.add("popup__photo"),o.width=45,o.height=40,o.src=e[n],t.appendChild(o)}return t}(n.offer.photos)),o.dataset.id=n.id,o}}})(),function(){const{createCardElement:e}=window.card,t=document.querySelector(".map"),n=t.querySelector(".map__pins"),o=t.querySelector(".map__filters-container"),r=document.querySelector(".map__pin--main");function a(){document.querySelectorAll("article.map__card").forEach((e=>{const t=e.querySelector("button.popup__close");t.removeEventListener("click",i),t.removeEventListener("keydown",c),e.remove()}))}function i(){a()}function c(e){"Escape"===e.key&&a()}function u(){document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}window.map={map:t,mapPinMain:r,getMainPinAddress:function(){return{x:Math.floor(parseInt(r.style.left,10)+32.5),y:Math.floor(parseInt(r.style.top,10)+32.5)}},getMainPinAddressWithTail:function(){return{x:Math.floor(parseInt(r.style.left,10)+32.5),y:Math.floor(parseInt(r.style.top,10)+65+22)}},activateMap:function(n){t.classList.remove("map--faded"),t.addEventListener("click",function(n){return function(r){if(r.target.parentNode.classList.contains("map__pin")){const u=r.target.parentNode.dataset.offerId;if(u){a();const r=e(n[u]);t.insertBefore(r,o);const s=r.querySelector("button.popup__close");s.addEventListener("click",i),s.addEventListener("keydown",c)}}}}(n))},deactivateMap:function(){u(),a(),t.classList.add("map--faded")},removeCards:a,removePins:u,renderPins:function(e){n.appendChild(e)},MAIN_PIN_HEIGHT:65,MAIN_PIN_TAIL_HEIGHT:22,MAIN_PIN_WIDTH:65,MAP_WIDTH:1200,MAP_HEIGHT_TOP:130,MAP_HEIGHT_BOTTOM:630}}(),(()=>{const{debounce:e}=window.utils,{removeCards:t,removePins:n,renderPins:o}=window.map,{generatePins:r}=window.pin,a=document.querySelector("#housing-type"),i=document.querySelector("#housing-price"),c=document.querySelector("#housing-rooms"),u=document.querySelector("#housing-guests"),s=document.querySelector("#housing-features");let d=[];function l(e){return"any"===a.value||a.value===e.offer.type}function f(e){return"any"===i.value||"low"===i.value&&e.offer.price<1e4||"middle"===i.value&&e.offer.price>=1e4&&e.offer.price<5e4||"high"===i.value&&e.offer.price>=5e4}function m(e){return"any"===c.value||c.value===e.offer.rooms.toString()}function p(e){return"any"===u.value||u.value===e.offer.guests.toString()}function v(e){const t=s.querySelectorAll("input:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))}function y(){let e=[];e=d.filter(l).filter(f).filter(m).filter(p).filter(v),n(),t();const a=r(e);o(a)}function h(){e(y,500)()}window.filter={activateFilter:function(e){d=e,a.addEventListener("change",h),i.addEventListener("change",h),c.addEventListener("change",h),u.addEventListener("change",h),s.addEventListener("change",h)},deactivateFilter:function(){a.removeEventListener("change",h),i.removeEventListener("change",h),c.removeEventListener("change",h),u.removeEventListener("change",h),s.removeEventListener("change",h)}}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector(".ad-form-header"),n=document.querySelectorAll(".ad-form__element"),o=document.querySelector("#room_number"),r=document.querySelector("#address"),a=document.querySelector("#title"),i=document.querySelector("#price"),c=document.querySelector("#type"),u=document.querySelector("#timein"),s=document.querySelector("#timeout"),d=document.querySelector("#capacity").children;function l(){Array.from(d).forEach((e=>{e.setAttribute("disabled","disabled")})),"1"===o.value?Array.from(d).forEach((e=>{"1"===e.value&&e.removeAttribute("disabled","disabled")})):"2"===o.value?Array.from(d).forEach((e=>{"2"!==e.value&&"1"!==e.value||e.removeAttribute("disabled","disabled")})):"3"===o.value?Array.from(d).forEach((e=>{"0"!==e.value&&e.removeAttribute("disabled","disabled")})):Array.from(d).forEach((e=>{"0"===e.value&&e.removeAttribute("disabled","disabled")}))}function f(){"bungalow"===c.value?(i.min=0,i.placeholder="0",i.setCustomValidity("Минимальная цена за ночь - 0")):"flat"===c.value?(i.min=1e3,i.placeholder="1000",i.setCustomValidity("Минимальная цена за ночь - 1000")):"house"===c.value?(i.min=5e3,i.placeholder="5000",i.setCustomValidity("Минимальная цена за ночь - 5000")):"palace"===c.value?(i.min=1e4,i.placeholder="10000",i.setCustomValidity("Минимальная цена за ночь - 10000")):i.setCustomValidity(""),i.reportValidity()}function m(){const e=a.value.length;e<30?a.setCustomValidity(`Еще ${30-e} симв.`):e>100?a.setCustomValidity(`Удалите лишние ${e-100} симв.`):a.setCustomValidity(""),a.reportValidity()}function p(){i.value>1e6?i.setCustomValidity("Максимальная цена за ночь - 1000000"):i.setCustomValidity(""),i.reportValidity()}function v(e){u.value=e.target.value,s.value=e.target.value}function y(e){r.value=e}window.form={form:e,activateForm:function(r){e.classList.remove("ad-form--disabled"),t.removeAttribute("disabled"),n.forEach((e=>{e.removeAttribute("disabled")})),l(),f(),y(`${r.x}, ${r.y}`),o.addEventListener("change",l),a.addEventListener("input",m),i.addEventListener("input",p),c.addEventListener("change",f),u.addEventListener("change",v),s.addEventListener("change",v)},deactivateForm:function(r){e.reset(),e.classList.add("ad-form--disabled"),t.setAttribute("disabled","disabled"),n.forEach((e=>{e.setAttribute("disabled","disabled")})),y(`${r.x}, ${r.y}`),o.removeEventListener("change",l),a.removeEventListener("input",m),i.removeEventListener("input",p),c.removeEventListener("change",f),u.removeEventListener("change",v),s.removeEventListener("change",v)},setAddressValue:y}})(),(()=>{const{map:e,mapPinMain:t,getMainPinAddressWithTail:n,MAIN_PIN_HEIGHT:o,MAIN_PIN_TAIL_HEIGHT:r,MAIN_PIN_WIDTH:a,MAP_WIDTH:i,MAP_HEIGHT_TOP:c,MAP_HEIGHT_BOTTOM:u}=window.map,{setAddressValue:s}=window.form,d=c-o-r,l=u-o-r,f=-a/2,m=i-a/2;let p={x:t.offsetLeft,y:t.offsetTop};function v(e){e.preventDefault();const o=p.x-e.clientX,r=p.y-e.clientY;p={x:e.clientX,y:e.clientY};const a={x:t.offsetLeft-o,y:t.offsetTop-r};t.style.top=function(e){return e.y<=d?d+"px":e.y>=l?l+"px":e.y+"px"}(a),t.style.left=function(e){return e.x<=f?f+"px":e.y>=m?m+"px":e.x+"px"}(a);const i=n();s(`${i.x}, ${i.y}`)}function y(t){t.preventDefault(),e.removeEventListener("mousemove",v),e.removeEventListener("mouseup",y)}t.addEventListener("mousedown",(function(t){t.preventDefault(),p={x:t.clientX,y:t.clientY},e.addEventListener("mousemove",v),e.addEventListener("mouseup",y)}))})(),(()=>{const{mapPinMain:e,activateMap:t,deactivateMap:n,getMainPinAddress:o,getMainPinAddressWithTail:r,renderPins:a}=window.map,{activateForm:i,deactivateForm:c,form:u}=window.form,{generatePins:s}=window.pin,{loadData:d,uploadData:l}=window.ajax,{activateFilter:f,deactivateFilter:m}=window.filter,p=document.querySelector("main"),v=document.querySelector(".ad-form__reset");function y(){I()}function h(e){"Enter"===e.key&&I()}function _(e,t){return e.id=t,e}function E(e){const t=document.querySelector("#error-message");t.querySelector(".error__message").textContent=e,t.classList.remove("hidden")}function g(){w()}function L(e){"Escape"===e.key&&w()}function S(){A()}function q(e){"Escape"===e.key&&A()}function w(){document.querySelector("#error-message").classList.add("hidden")}function A(){document.querySelector(".success").classList.add("hidden")}function b(){T(),document.querySelector(".success").classList.remove("hidden"),document.addEventListener("mousedown",S),document.addEventListener("keydown",q)}function M(){T()}function x(e){e.preventDefault(),l("https://21.javascript.pages.academy/keksobooking",new FormData(u),b,E)}function I(){d("https://21.javascript.pages.academy/keksobooking/data",(n=>{const o=r(),c=n.map(_),d=s(c);a(d),e.removeEventListener("mousedown",y),e.removeEventListener("keydown",h),t(c),i(o),f(c),u.addEventListener("submit",x),v.addEventListener("click",M)}),E)}function T(){const t=o();e.addEventListener("mousedown",y),e.addEventListener("keydown",h),n(),c(t),m(),u.removeEventListener("submit",x),v.removeEventListener("click",M)}T(),function(){const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),t=e.querySelector(".error__button");e.id="error-message",e.classList.add("hidden"),p.appendChild(e),t.addEventListener("mousedown",g),t.addEventListener("keydown",L)}(),function(){const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);e.classList.add("hidden"),p.appendChild(e)}()})()})();